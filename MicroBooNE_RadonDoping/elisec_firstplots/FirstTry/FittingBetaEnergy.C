/// Psuedo code:
/*

  Go through all the truth particles 
  
  Identify the "primary" beta and alpha 
  
  Once identified store their energies
  
*/


// Standard things to include
#include <iostream>
#include <stdlib.h>
#include <string>
#include <vector>

#include <fstream>
#include <iterator>
#include <algorithm>
#include <math.h> 
// These are the includes to use "Root" things 
#include "TInterpreter.h"
#include "TROOT.h"
#include "TH1F.h"
#include "TH2D.h"
#include "TTree.h"
#include "TFile.h"
#include "TLorentzVector.h"

// These are the larsoft includes that let you
// have access to data-products and the event 
// details
#include "canvas/Utilities/InputTag.h"
#include "gallery/Event.h"
#include "gallery/ValidHandle.h"
#include "gallery/Handle.h"
#include "canvas/Persistency/Common/FindMany.h"
#include "canvas/Persistency/Common/FindOne.h"
#include "canvas/Persistency/Common/FindManyP.h"
#include "canvas/Persistency/Common/fwd.h"
#include "canvas/Persistency/Common/Ptr.h"
#include "canvas/Persistency/Provenance/Timestamp.h"

//I'll only need truth particle info for now:
#include "nusimdata/SimulationBase/MCParticle.h"
#include "lardataobj/AnalysisBase/BackTrackerMatchingData.h"

//This way you can be lazy
using namespace art;
using namespace std;

//This Block Lets us convert a TGraph with 
// a free normalization term
// Moving forward this is the function that will be fit to
// our reconstructed energy distributions so we'll 
// modify this to include terms that could smear this 
// data out
TGraph *BetaData;
double FittedFunction(double *xx, double *par)
{
  return par[0]*BetaData->Eval(xx[0]);
}

void FittingBetaEnergy(){

  // create a vector of files we want to process
  //  std::vector<std::string> filenames;
  
  // read in a file list that we get from a sam-def but remember it 
  // is very long so if we want to run over it all it'll take a while
  // and we'll probably want to break it up on the grid
  //ifstream myfile("my_filelist.list");
  //copy(istream_iterator<string>(myfile),
  //     istream_iterator<string>(),
  //     back_inserter(filenames));
  
  //We'll just check the first 10k files for now
  //filenames.erase(filenames.begin()+10000,filenames.end());
  
  //Here I just hard coding a file for testing, we can adjust this later 
  vector<string> filenames {"/pnfs/uboone/scratch/users/jaz8600/BiPo_overlay_BetterDL_2300perEvent/A/v08_00_00_41/44567749_1/BeamOffRun-2018_7_9_0_9_13-0017597-00078_20180713T201835_ext_unbiased_2_20210525T220436_simmxd_detsim_mix_r1a_r1b_r1c_detsim_mix_r1a.root"};
  
  // Here we will create all of our histograms 
  TFile* out = new TFile("outfile_mc_TEST.root","RECREATE");  
  TTree* fTree = new TTree("hit_v_track","HitPropertiesTrackProperties");
  
  //The range can be checked online, but :
  //    Bi214 beta's cut off at 3.3 MeV and
  //    Po214 alpha's are monoenergetic at ~7.7 MeV
  TH1F* Bi214_betaEnergy = new TH1F("Bi214_betaEnergy","",1000,0, 5);
  TH1F* Po214_alphaEnergy = new TH1F("Po214_alphaEnergy","",100,6, 8);
  // Add new histograms here! 

  //We don't really want to include the Auger electrons:
  //  https://www.nndc.bnl.gov/nudat2/decaysearchdirect.jsp?nuc=214Bi&unc=nds
  std::vector<double> AugerElecs;// = {0.008,0.516,1.323,0.592,1.027,0.296,0.060,1.671,0.675,0.841,1.145,0.605,0.294,1.103,0.256,0.610,1.062,0.372,1.188,1.285,0.751,1.416,0.608,2.111,0.259,0.713,0.917,1.748,1.221,0.377,0.370,1.315,1.116,0.572,0.381,0.368,1.636,1.924,0.313,1.308,0.332,0.728,0.627,0.211,0.450,1.490,0.686,0.385,0.733,0.764,0.959,1.138,0.362,0.660,2.025,0.389,0.789,1.568,0.609,0.335,0.360,0.930,1.760,1.361,1.234,1.264,1.492,0.160,0.453,0.540,0.383,0.556,1.119,2.187,0.605,0.568,0.128,0.458,1.502,1.391,0.240,0.649,1.041,0.345,0.444,0.693,1.713,0.703,1.292,0.287,0.648,1.3215,1.32994};

  // Here we will loop through all the events in that file:
  for (gallery::Event ev(filenames) ; !ev.atEnd(); ev.next()) {
    
    // We want to get new "data products" out of the files here
    // currently we are intersted in the truth particles 
    //  .. You can find more data products on the event by doing:
    //       rootstat.py <file_name>.root if uboonecode is setup
    auto const &mcpart_handle =    
      ev.getValidHandle< std::vector<simb::MCParticle> >("largeant");

    //Convert our C++ "pointer" into an object
    // this is now and std::vector<simb::MCParticle> 
    auto mcparts(*mcpart_handle);

    //We don't want to study Auger electrons:
    bool isAuger = false;

    // We can iterate through all the truth particles
    for(int mcp = 0; mcp < mcparts.size(); mcp++){
      
      isAuger = false;

      //reject anything that is not the particles from the decay
      if(mcparts[mcp].Mother() != 0) continue;      

      if(mcparts[mcp].PdgCode() == 11) // check if it is a beta
	{
	  // Here .E(0) is the total starting energy
	  // we are most interested in the kinetic energy 
	  // so we'll subtract the Mass() of the particle
	  // also LArSoft uses GeV so we convert to MeV by *1000

	  //skip all the Auger electrons:
	  for(int i = 0; i < AugerElecs.size(); i++){	    
	    if(abs((mcparts[mcp].E(0)-mcparts[mcp].Mass())*1000. - AugerElecs[i]) < 0.0005) isAuger = true;
	  }

	  if(isAuger == true) continue;
	  
	  Bi214_betaEnergy->Fill((mcparts[mcp].E(0)-mcparts[mcp].Mass())*1000.);
	} // end beta check
      else if(mcparts[mcp].PdgCode() == 1000020040)
	{
	  Po214_alphaEnergy->Fill((mcparts[mcp].E(0)-mcparts[mcp].Mass())*1000.);
	} // end alpha check
      else
	{continue;}//throw away everything else
    } // end loop over truth particles
  } // end loop over events 

  // Now let's make plots!
  // First we make a canvas
  TCanvas* c1 = new TCanvas();
  c1->cd();
  // now we can draw our plots! 
  Bi214_betaEnergy->Draw("");

  // Let's make the 214Bi spectrum:
  int bins = 431;
  double energy_center[431] = {0.0,0.0002,0.0004,0.0006,0.0008,0.001,0.0015,0.002,0.0025,0.003,0.0035,0.004,0.0045,0.005,0.0055,0.006,0.0065,0.007,0.0075,0.008,0.0085,0.009,0.0095,0.01,0.011,0.012,0.013,0.014,0.015,0.016,0.017,0.018,0.019,0.02,0.021,0.022,0.023,0.024,0.025,0.026,0.027,0.028,0.029,0.03,0.031,0.032,0.033,0.034,0.035,0.036,0.037,0.038,0.039,0.04,0.041,0.042,0.043,0.044,0.045,0.046,0.047,0.048,0.049,0.05,0.051,0.052,0.053,0.054,0.055,0.056,0.057,0.058,0.059,0.06,0.061,0.062,0.063,0.064,0.065,0.066,0.067,0.068,0.069,0.07,0.071,0.072,0.073,0.074,0.075,0.076,0.077,0.078,0.079,0.08,0.081,0.082,0.083,0.084,0.085,0.086,0.087,0.088,0.089,0.09,0.091,0.092,0.093,0.094,0.095,0.096,0.097,0.098,0.099,0.1,0.11,0.12,0.13,0.14,0.15,0.16,0.17,0.18,0.19,0.2,0.21,0.22,0.23,0.24,0.25,0.26,0.27,0.28,0.29,0.3,0.31,0.32,0.33,0.34,0.35,0.36,0.37,0.38,0.39,0.4,0.41,0.42,0.43,0.44,0.45,0.46,0.47,0.48,0.49,0.5,0.51,0.52,0.53,0.54,0.55,0.56,0.57,0.58,0.59,0.6,0.61,0.62,0.63,0.64,0.65,0.66,0.67,0.68,0.69,0.7,0.71,0.72,0.73,0.74,0.75,0.76,0.77,0.78,0.79,0.8,0.81,0.82,0.83,0.84,0.85,0.86,0.87,0.88,0.89,0.9,0.91,0.92,0.93,0.94,0.95,0.96,0.97,0.98,0.99,1.0,1.01,1.02,1.03,1.04,1.05,1.06,1.07,1.08,1.09,1.1,1.11,1.12,1.13,1.14,1.15,1.16,1.17,1.18,1.19,1.2,1.21,1.22,1.23,1.24,1.25,1.26,1.27,1.28,1.29,1.3,1.31,1.32,1.33,1.34,1.35,1.36,1.37,1.38,1.39,1.4,1.41,1.42,1.43,1.44,1.45,1.46,1.47,1.48,1.49,1.5,1.51,1.52,1.53,1.54,1.55,1.56,1.57,1.58,1.59,1.6,1.61,1.62,1.63,1.64,1.65,1.66,1.67,1.68,1.69,1.7,1.71,1.72,1.73,1.74,1.75,1.76,1.77,1.78,1.79,1.8,1.81,1.82,1.83,1.84,1.85,1.86,1.87,1.88,1.89,1.9,1.91,1.92,1.93,1.94,1.95,1.96,1.97,1.98,1.99,2.0,2.01,2.02,2.03,2.04,2.05,2.06,2.07,2.08,2.09,2.1,2.11,2.12,2.13,2.14,2.15,2.16,2.17,2.18,2.19,2.2,2.21,2.22,2.23,2.24,2.25,2.26,2.27,2.28,2.29,2.3,2.31,2.32,2.33,2.34,2.35,2.36,2.37,2.38,2.39,2.4,2.41,2.42,2.43,2.44,2.45,2.46,2.47,2.48,2.49,2.5,2.51,2.52,2.53,2.54,2.55,2.56,2.57,2.58,2.59,2.6,2.61,2.62,2.63,2.64,2.65,2.66,2.67,2.68,2.69,2.7,2.71,2.72,2.73,2.74,2.75,2.76,2.77,2.78,2.79,2.8,2.81,2.82,2.83,2.84,2.85,2.86,2.87,2.88,2.89,2.9,2.91,2.92,2.93,2.94,2.95,2.96,2.97,2.98,2.99,3.0,3.01,3.02,3.03,3.04,3.05,3.06,3.07,3.08,3.09,3.1,3.11,3.12,3.13,3.14,3.15,3.16,3.17,3.18,3.19,3.2,3.21,3.22,3.23,3.24,3.25,3.26,3.27};
  double intensity[431] = {0.000845889,0.000848738,0.000851375,0.000853799,0.00085604,0.000858107,0.000862577,0.000866105,0.000868823,0.000870856,0.000872833,0.000874557,0.00087614,0.00087755,0.000878817,0.000879932,0.000881079,0.000882151,0.000883153,0.000884083,0.000884966,0.000885788,0.000886631,0.000887437,0.000888954,0.000890336,0.000891689,0.000892956,0.000894141,0.000895342,0.000896512,0.000897643,0.000898751,0.000899826,0.000900896,0.000901946,0.000902977,0.000903987,0.000904985,0.000905974,0.000906949,0.000907912,0.000908863,0.000909801,0.000910736,0.000911661,0.000912576,0.000913483,0.000914381,0.000915272,0.000916155,0.00091703,0.000917898,0.000918758,0.000919612,0.000920459,0.0009213,0.000922134,0.000922961,0.000923783,0.000924598,0.000925406,0.000926209,0.000927006,0.000927797,0.000928582,0.000929361,0.000930135,0.000930903,0.000931666,0.000932423,0.000933174,0.00093392,0.000934661,0.000935396,0.000936127,0.000936851,0.000937571,0.000938286,0.000938995,0.0009397,0.000940399,0.000941094,0.000941783,0.000942468,0.000943147,0.000943822,0.000944492,0.000945157,0.000945818,0.000946474,0.000947125,0.000947771,0.000948413,0.000949051,0.000949684,0.000950312,0.000950936,0.000951556,0.00095217,0.00095278,0.000953386,0.000953987,0.000954583,0.000955175,0.000955762,0.000956344,0.000956923,0.000957496,0.000958065,0.00095863,0.00095919,0.000959746,0.000960297,0.00096557,0.000970412,0.000974835,0.000978844,0.000982447,0.000985653,0.000988472,0.000990914,0.000992986,0.00099469,0.000996033,0.000997022,0.000997644,0.000997897,0.000997794,0.00099734,0.000996527,0.000995355,0.000993826,0.000991944,0.000989716,0.000987148,0.000984251,0.000981027,0.000977479,0.000973614,0.000969441,0.000964965,0.000960198,0.000955149,0.000949823,0.00094423,0.000938378,0.000932277,0.000925938,0.00091937,0.000912584,0.000905591,0.000898404,0.000891032,0.000883482,0.000875767,0.000867897,0.000859888,0.000851733,0.000843412,0.000834924,0.000826275,0.000817455,0.000808473,0.00079934,0.00079006,0.000780642,0.000771096,0.000761433,0.000751663,0.000741796,0.000731838,0.000721798,0.00071169,0.000701522,0.00069131,0.00068106,0.000670787,0.0006605,0.000650213,0.000639936,0.000629674,0.000619435,0.00060921,0.000598995,0.000588802,0.000578618,0.000568402,0.000558161,0.000547905,0.00053764,0.000527376,0.000517122,0.000506888,0.000496683,0.000486515,0.000476397,0.000466335,0.000456341,0.000446423,0.000436593,0.000426858,0.000417223,0.000407695,0.000398283,0.000388995,0.00037984,0.000370828,0.00036197,0.000353275,0.000344747,0.000336336,0.000328029,0.00031983,0.000311747,0.000303787,0.000295958,0.000288263,0.00028071,0.000273287,0.000265971,0.000258768,0.000251685,0.000244727,0.000237903,0.000231218,0.00022468,0.000218296,0.000212071,0.000206009,0.000200091,0.000194316,0.000188682,0.000183194,0.000177858,0.000172681,0.000167667,0.000162825,0.000158158,0.000153675,0.00014938,0.000145281,0.000141377,0.00013767,0.000134164,0.000130867,0.00012777,0.00012484,0.000122079,0.000119492,0.000117085,0.000114863,0.000112829,0.000110989,0.000109335,0.000107797,0.000106365,0.000105042,0.000103782,0.000102538,0.000101309,0.000100097,0.0000989025,0.0000977256,0.0000965675,0.0000954272,0.0000943043,0.0000931997,0.0000921139,0.000091048,0.0000900026,0.0000889784,0.0000879764,0.0000869972,0.0000860418,0.0000851108,0.0000842044,0.0000833144,0.0000824382,0.0000815763,0.0000807295,0.0000798981,0.0000790828,0.0000782843,0.0000775029,0.0000767393,0.000075994,0.0000752678,0.0000745609,0.0000738738,0.0000732046,0.0000725535,0.0000719209,0.0000712997,0.0000706746,0.0000700453,0.0000694121,0.0000687748,0.0000681338,0.000067489,0.0000668405,0.0000661886,0.0000655334,0.0000648748,0.0000642131,0.0000635484,0.0000628808,0.0000622104,0.0000615374,0.0000608617,0.0000601837,0.0000595034,0.0000588208,0.0000581364,0.0000574498,0.0000567615,0.0000560715,0.00005538,0.0000546871,0.0000539928,0.0000532974,0.0000526009,0.0000519034,0.0000512053,0.0000505064,0.0000498071,0.0000491073,0.0000484073,0.0000477071,0.0000470069,0.0000463068,0.0000456071,0.0000449076,0.0000442088,0.0000435105,0.0000428132,0.0000421167,0.0000414214,0.0000407272,0.0000400345,0.0000393431,0.0000386534,0.0000379654,0.0000372795,0.0000365955,0.0000359137,0.0000352343,0.0000345573,0.0000338829,0.0000332113,0.0000325425,0.0000318768,0.0000312144,0.0000305552,0.0000298995,0.0000292474,0.0000285991,0.0000279547,0.0000273143,0.0000266781,0.0000260464,0.0000254191,0.0000247964,0.0000241785,0.0000235656,0.0000229578,0.0000223551,0.0000217579,0.0000211661,0.0000205802,0.0000199997,0.0000194245,0.0000188546,0.0000182902,0.0000177315,0.0000171786,0.0000166317,0.0000160908,0.0000155562,0.0000150279,0.0000145061,0.0000139911,0.0000134828,0.0000129815,0.0000124873,0.0000120003,0.0000115207,0.0000110487,0.0000105843,0.0000101278,0.00000967931,0.00000923891,0.00000880679,0.0000083831,0.00000796799,0.0000075616,0.00000716408,0.00000677559,0.00000639627,0.00000602627,0.00000566574,0.00000531483,0.0000049737,0.00000464249,0.00000432136,0.00000401045,0.00000370991,0.0000034199,0.00000314056,0.00000287206,0.00000261453,0.00000236813,0.00000213302,0.00000190934,0.00000169724,0.00000149687,0.00000130839,0.00000113194,0.000000967674,0.000000815744,0.000000676297,0.00000054948,0.00000043544,0.000000334325,0.000000246277,0.000000171439,0.00000010995,0.0000000619436,0.0000000275479,0.0000000068757,0.0};
  
  //This converts the "Beta-Data" into a TGraph
  BetaData = new TGraph(bins, energy_center, intensity);

  //We can now turn this TGraph into a function
  // then we can use this function to fit the data 
  // ** The final value in this arguement is the number 
  // of parameters you are looking to fit
  TF1 *betadata = new TF1("betadata",FittedFunction,0,3.27,1);
  Bi214_betaEnergy->Fit("betadata");
  Bi214_betaEnergy->GetXaxis()->SetTitle("Bi214 Energy (MeV)");
  Bi214_betaEnergy->GetYaxis()->SetTitle("Events");
  Bi214_betaEnergy->SetTitle("Fitted Beta Spectrum");
  betadata->Draw("same");
  

}// End Program




